# Database Schema & Setup

The Schwab ELT ETL Pipeline uses SQL Server to store all collected financial data, API tokens, and system configuration. This document outlines the database structure and setup procedures.

## Database Overview

### Schema Organization
- **`OPT.SCHWAB.*`** - Raw Schwab API data storage
- **`OPT.PYTHON.*`** - Processed and structured data
- **`CHAINS.dbo.*`** - Option chains data

### Key Design Principles
- Raw data preservation for audit trails
- Structured data for analysis and reporting
- Efficient indexing for time-series queries
- Stored procedures for data processing

## Core Tables

### 1. API Authentication (`OPT.SCHWAB.API`)

Stores OAuth2 tokens and authentication data.

**Columns**:
- `api_name` (VARCHAR) - API identifier (e.g., "MAIN_DATA", "MAIN_TRADE")
- `access_token` (TEXT) - Current access token
- `refresh_token` (TEXT) - Refresh token for token renewal
- `expires_at` (DATETIME) - Token expiration timestamp
- `created_at` (DATETIME) - Token creation timestamp
- `updated_at` (DATETIME) - Last token update

**Usage**: Automatic token management by `tools.db` and `tools.schwab` modules.

### 2. Account Balances (`OPT.SCHWAB.BALANCES`)

Daily account balance and position snapshots.

**Columns**:
- `account_hash` (VARCHAR) - Encrypted account identifier
- `balance_date` (DATE) - Balance snapshot date
- `total_value` (DECIMAL) - Total account value
- `cash_balance` (DECIMAL) - Available cash
- `buying_power` (DECIMAL) - Available buying power
- `positions` (JSON) - Position details in JSON format
- `created_at` (DATETIME) - Record creation timestamp

**Usage**: Updated daily by `schwab_balances_service.py`.

### 3. Market Hours (`OPT.SCHWAB.MARKET_HOURS`)

Trading session schedules and market status.

**Columns**:
- `market_date` (DATE) - Trading date
- `is_open` (BIT) - Whether market is open
- `session_hours` (JSON) - Detailed session timing
- `pre_market_start` (TIME) - Pre-market session start
- `regular_start` (TIME) - Regular session start
- `regular_end` (TIME) - Regular session end
- `post_market_end` (TIME) - Post-market session end

**Usage**: Foundation for all service scheduling and market hours awareness.

### 4. Raw Transactions (`OPT.SCHWAB.JSON_TRANSACTIONS`)

Complete audit trail of all transaction data from Schwab API.

**Columns**:
- `transaction_id` (BIGINT) - Unique transaction identifier
- `account_hash` (VARCHAR) - Account identifier
- `raw_json` (TEXT) - Complete JSON response from API
- `transaction_date` (DATETIME) - Transaction timestamp
- `created_at` (DATETIME) - Record creation timestamp

**Usage**: Raw data storage by `schwab_transactions_service.py`.

### 5. Account Hash (`OPT.SCHWAB.HASH`)

Secure storage of account hash information.

**Columns**:
- `account_number` (VARCHAR) - Account number reference
- `account_hash` (VARCHAR) - Schwab-generated account hash
- `created_at` (DATETIME) - Hash creation timestamp

**Usage**: Generated by `scripts/schwab_hash.py`, used for API calls.

### 6. Processed Orders (`OPT.PYTHON.Orders`)

Structured transaction data processed from raw JSON.

**Columns**:
- `order_id` (BIGINT) - Unique order identifier
- `account_hash` (VARCHAR) - Account identifier
- `symbol` (VARCHAR) - Trading symbol
- `order_type` (VARCHAR) - Order type (BUY, SELL, etc.)
- `quantity` (INT) - Number of shares/contracts
- `price` (DECIMAL) - Execution price
- `order_date` (DATETIME) - Order timestamp
- `status` (VARCHAR) - Order status
- `processed_at` (DATETIME) - Processing timestamp

**Usage**: Populated by `SP_PY_PARSE_TRANSACTIONS` stored procedure.

### 7. Option Chains (`CHAINS.dbo.SPX_CHAIN`)

SPX option chains data with multiple collection frequencies.

**Columns**:
- `chain_id` (BIGINT) - Unique chain record identifier
- `symbol` (VARCHAR) - Underlying symbol ($SPX)
- `expiration_date` (DATE) - Option expiration date
- `strike_price` (DECIMAL) - Strike price
- `option_type` (CHAR) - 'C' for Call, 'P' for Put
- `bid` (DECIMAL) - Bid price
- `ask` (DECIMAL) - Ask price
- `last` (DECIMAL) - Last traded price
- `volume` (INT) - Trading volume
- `open_interest` (INT) - Open interest
- `implied_volatility` (DECIMAL) - Implied volatility
- `delta` (DECIMAL) - Option delta
- `gamma` (DECIMAL) - Option gamma
- `theta` (DECIMAL) - Option theta
- `vega` (DECIMAL) - Option vega
- `collection_frequency` (VARCHAR) - Collection interval (1min, 5min, 30min)
- `collected_at` (DATETIME) - Data collection timestamp

**Usage**: Populated by `schwab_chains_service.py` at multiple frequencies.

## Stored Procedures

### 1. `OPT.PYTHON.SP_PY_PROCESS_OHLC`

Processes raw OHLC data into structured format.

**Parameters**:
- `@symbol` - Trading symbol
- `@data_type` - 'minute' or 'daily'
- `@start_date` - Processing start date
- `@end_date` - Processing end date

**Purpose**: Converts raw price data into normalized OHLC records.

### 2. `OPT.PYTHON.SP_PY_PARSE_TRANSACTIONS`

Parses raw JSON transaction data into structured records.

**Parameters**:
- `@account_hash` - Account identifier
- `@start_date` - Processing start date
- `@end_date` - Processing end date

**Purpose**: Extracts structured order data from raw JSON for analysis.

## Database Setup

### 1. Initial Schema Creation

```sql
-- Execute the main schema script
sqlcmd -S your_server -d your_database -i sql/opt.sql
```

### 2. Create Indexes

```sql
-- Performance indexes for time-series queries
CREATE INDEX IX_CHAINS_SYMBOL_DATE ON CHAINS.dbo.SPX_CHAIN (symbol, collected_at);
CREATE INDEX IX_TRANSACTIONS_DATE ON OPT.SCHWAB.JSON_TRANSACTIONS (transaction_date);
CREATE INDEX IX_ORDERS_SYMBOL_DATE ON OPT.PYTHON.Orders (symbol, order_date);
CREATE INDEX IX_BALANCES_DATE ON OPT.SCHWAB.BALANCES (balance_date);
```

### 3. Setup Permissions

```sql
-- Create application user
CREATE LOGIN schwab_app WITH PASSWORD = 'your_secure_password';
CREATE USER schwab_app FOR LOGIN schwab_app;

-- Grant necessary permissions
GRANT SELECT, INSERT, UPDATE ON OPT.SCHWAB.* TO schwab_app;
GRANT SELECT, INSERT, UPDATE ON OPT.PYTHON.* TO schwab_app;
GRANT SELECT, INSERT, UPDATE ON CHAINS.dbo.* TO schwab_app;
GRANT EXECUTE ON OPT.PYTHON.SP_PY_PROCESS_OHLC TO schwab_app;
GRANT EXECUTE ON OPT.PYTHON.SP_PY_PARSE_TRANSACTIONS TO schwab_app;
```

## Data Flow

### 1. Authentication Flow
```
Schwab API → OPT.SCHWAB.API (tokens)
```

### 2. Market Data Flow
```
Schwab API → Raw Storage → Processing → Structured Tables
```

### 3. Transaction Flow
```
Schwab API → OPT.SCHWAB.JSON_TRANSACTIONS → SP_PY_PARSE_TRANSACTIONS → OPT.PYTHON.Orders
```

### 4. Option Chains Flow
```
Schwab API → CHAINS.dbo.SPX_CHAIN (direct insertion)
```

## Maintenance

### Daily Tasks
- Monitor table growth and performance
- Check for failed stored procedure executions
- Validate data integrity

### Weekly Tasks
- Update statistics on large tables
- Review and optimize slow queries
- Archive old data if needed

### Monthly Tasks
- Rebuild indexes on heavily used tables
- Review storage usage and growth
- Update stored procedures if needed

## Performance Considerations

### Indexing Strategy
- Time-based indexes for all time-series data
- Composite indexes for common query patterns
- Regular index maintenance and statistics updates

### Partitioning
Consider partitioning large tables by date:
```sql
-- Example partitioning for option chains
ALTER TABLE CHAINS.dbo.SPX_CHAIN 
PARTITION BY RANGE (collected_at);
```

### Query Optimization
- Use parameterized queries to prevent SQL injection
- Implement proper WHERE clause filtering
- Monitor query execution plans

## Backup and Recovery

### Backup Strategy
```sql
-- Daily full backup
BACKUP DATABASE YourDatabase 
TO DISK = 'C:\Backups\YourDatabase_Full.bak'
WITH COMPRESSION, CHECKSUM;

-- Hourly transaction log backup
BACKUP LOG YourDatabase 
TO DISK = 'C:\Backups\YourDatabase_Log.trn';
```

### Recovery Testing
- Regular restore testing to verify backup integrity
- Document recovery procedures
- Test point-in-time recovery scenarios

## Monitoring

### Key Metrics
- Table growth rates
- Query performance
- Index usage statistics
- Storage utilization

### Alerts
- Failed stored procedure executions
- Unusual data volume changes
- Performance degradation
- Storage space warnings

For connection configuration, see [Configuration Reference](configuration.md).
